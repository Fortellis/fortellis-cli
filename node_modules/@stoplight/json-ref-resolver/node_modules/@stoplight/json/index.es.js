import{createScanner as e,findNodeAtOffset as r,getNodePath as n,visit as t,printParseErrorCode as i}from"jsonc-parser";import{isObject as o,trimStart as a}from"lodash";import{DiagnosticSeverity as s}from"@stoplight/types";import c from"safe-stable-stringify";const u=(e,r,n)=>{const t=e.toString();let i="",o=t,a=0,s=o.indexOf(r);for(;s>-1;)i+=t.substring(a,a+s)+n,o=o.substring(s+r.length,o.length),a+=s+r.length,s=o.indexOf(r);return o.length>0&&(i+=t.substring(t.length-o.length,t.length)),i},l=e=>u(u(decodeURIComponent(""+e),"~1","/"),"~0","~"),f=e=>u(u(e,"~1","/"),"~0","~"),p=e=>u(u(e,"~","~0"),"//","/~1"),h=e=>"number"==typeof e?e:u(u(e,"~","~0"),"/","~1"),g=e=>{if("string"!=typeof e||0===e.length)return null;const r=e.indexOf("#");return-1===r?null:e.slice(r)},y=e=>e.length>0&&"#"===e[0],d=e=>{if("string"!=typeof e||0===e.length||y(e))return null;const r=e.indexOf("#");return-1===r?e:e.slice(0,r)},m=r=>{const n=e(r,!0);if(n.scan(),1!==n.getToken())return;if(n.scan(),2===n.getToken())return;if(10!==n.getToken())throw new SyntaxError("Unexpected character");const t=n.getTokenValue();if(n.scan(),6!==n.getToken())throw new SyntaxError("Colon expected");switch(n.scan(),n.getToken()){case 10:return[t,n.getTokenValue()];case 11:return[t,Number(n.getTokenValue())];case 8:return[t,!0];case 9:return[t,!1];case 7:return[t,null];case 16:throw new SyntaxError("Unexpected character");case 17:throw new SyntaxError("Unexpected end of file");default:return}},b=({lineMap:e,ast:t},i)=>{const o=e[i.line],a=e[i.line+1];if(void 0===o)return;const s=r(t,void 0===a?o+i.character:Math.min(a,o+i.character),!0);if(void 0===s)return;const c=n(s);return 0!==c.length?c:void 0};function w(e){return f(e.split("/").pop()||"")}const v=({lineMap:e,ast:r},n,t=!1)=>{const i=function(e,r,n){e:for(const t of r){const r=Number.isInteger(Number(t))?Number(t):t;if("string"==typeof r||"number"==typeof r&&"array"!==e.type){if("object"!==e.type||!Array.isArray(e.children))return n?e:void 0;for(const n of e.children)if(Array.isArray(n.children)&&n.children[0].value===String(r)){e=n.children[1];continue e}return n?e:void 0}if("array"!==e.type||r<0||!Array.isArray(e.children)||r>=e.children.length)return n?e:void 0;e=e.children[r]}return e}(r,n,t);if(void 0!==i&&void 0!==i.range)return{range:i.range}};const O=e=>o(e)&&"$ref"in e&&"string"==typeof e.$ref,x=(e,r={disallowComments:!0})=>{const n=[],{ast:t,data:i,lineMap:o}=S(e,n,r);return{data:i,diagnostics:n,ast:t,lineMap:o}},N=Symbol("object_keys"),A={ownKeys:e=>e[N]};function S(e,r=[],n){const o=j(e);let a={type:"array",offset:-1,length:-1,children:[],parent:void 0},c=null,u=[];const l=new WeakMap,f=[];function p(e){"property"===a.type&&(a.length=e-a.offset,a=a.parent)}function h(e,r,n){return{start:{line:e,character:r},end:{line:e,character:r+n}}}function g(e){return a.children.push(e),e}function y(e){Array.isArray(u)?u.push(e):null!==c&&(u[c]=e)}function d(e){y(e),f.push(u),u=e,c=null}function m(){N in u&&u[N].push(N),u=f.pop()}t(e,{onObjectBegin:(e,r,t,i)=>{a=g({type:"object",offset:e,length:-1,parent:a,children:[],range:h(t,i,r)}),!1===n.ignoreDuplicateKeys&&l.set(a,[]),d(function(e){if(e){const e=new Proxy({},A);return Reflect.defineProperty(e,N,{value:[]}),e}return{}}(!0===n.preserveKeyOrder))},onObjectProperty:(e,t,i,o,f)=>{if((a=g({type:"property",offset:t,length:-1,parent:a,children:[]})).children.push({type:"string",value:e,offset:t,length:i,parent:a}),!1===n.ignoreDuplicateKeys){const n=l.get(a.parent);n&&(0!==n.length&&n.includes(e)?r.push({range:h(o,f,i),message:"DuplicateKey",severity:s.Error,path:k(a),code:20}):n.push(e))}!0===n.preserveKeyOrder&&N in u&&function(e,r){const n=r in e?e[N].indexOf(r):-1;-1!==n&&e[N].splice(n,1);e[N].push(r)}(u,e),c=e},onObjectEnd:(e,r,t,i)=>{!1===n.ignoreDuplicateKeys&&l.delete(a),a.length=e+r-a.offset,a.range&&(a.range.end.line=t,a.range.end.character=i+r),a=a.parent,p(e+r),m()},onArrayBegin:(e,r,n,t)=>{a=g({type:"array",offset:e,length:-1,parent:a,children:[],range:h(n,t,r)}),d([])},onArrayEnd:(e,r,n,t)=>{a.length=e+r-a.offset,a.range&&(a.range.end.line=n,a.range.end.character=t+r),a=a.parent,p(e+r),m()},onLiteralValue:(e,r,n,t,i)=>{g({type:E(e),offset:r,length:n,parent:a,value:e,range:h(t,i,n)}),p(r+n),y(e)},onSeparator:(e,r,n)=>{"property"===a.type&&(":"===e?a.colonOffset=r:","===e&&p(r))},onError:(e,n,t,o,a)=>{r.push({range:h(o,a,t),message:i(e),severity:s.Error,code:e})}},n);const b=a.children[0];return b&&delete b.parent,{ast:b,data:u[0],lineMap:o}}function E(e){switch(typeof e){case"boolean":return"boolean";case"number":return"number";case"string":return"string";default:return"null"}}const j=e=>{const r=[0];let n=0;for(;n<e.length;n++)"\n"===e[n]&&r.push(n+1);return r.push(n+1),r};function k(e,r=[]){return"property"===e.type&&r.unshift(e.children[0].value),void 0!==e.parent?("array"===e.parent.type&&void 0!==e.parent.parent&&r.unshift(e.parent.children.indexOf(e)),k(e.parent,r)):r}const I=e=>T(e),T=e=>{if(e&&"object"!=typeof e)throw new TypeError("Invalid type: path must be an array of segments.");return 0===e.length?"#":`#/${e.map(h).join("/")}`},P=e=>K(e),K=e=>{if("string"!=typeof e)throw new TypeError("Invalid type: JSON Pointers are represented as strings.");if(0===e.length||"#"!==e[0])throw new URIError("Invalid JSON Pointer syntax; URI fragment identifiers must begin with a hash.");if(1===e.length)return[];if("/"!==e[1])throw new URIError("Invalid JSON Pointer syntax.");return(e=>{const r=e.length,n=[];let t=-1;for(;++t<r;)n.push(l(e[t]));return n})(e.substring(2).split("/"))},M=(e,r,n)=>{if(!e||!Object.hasOwnProperty.call(e,r)||r===n)return e;const t={};for(const[i,o]of Object.entries(e))i===r?t[n]=o:i in t||(t[i]=o);return t},U=(e,r)=>{if("string"!=typeof e)return e;try{const n=J(e);return"string"==typeof n?n:JSON.parse(e,r)}catch(e){return}},J=e=>{const r=Number(e);return Number.isFinite(r)?String(r)===e?r:e:NaN},R=(e,r,n)=>{if("string"==typeof e)return e;try{return JSON.stringify(e,r,n)}catch(t){return c(e,r,n)}},D=(e,r)=>{if(e instanceof Array){if(r instanceof Array){if(r.length>e.length)return!1;for(const n in r){if(!r.hasOwnProperty(n))continue;const t=parseInt(e[n]),i=parseInt(r[n]);if(isNaN(t)&&isNaN(i)){if(e[n]!==r[n])return!1}else if(t!==i)return!1}}}else{if("string"!=typeof e)return!1;if("string"==typeof r)return e.startsWith(r)}return!0};function V(e){return e.replace(/^(\/|#\/)/,"").split("/").map(f).map($).join(".")}function $(e){return e.includes(".")?`["${e.replace(/"/g,'\\"')}"]`:e}function C(e,r){if("string"==typeof e&&"string"==typeof r)return a(e,r);if(!(e&&Array.isArray(e)&&e.length&&r&&Array.isArray(r)&&r.length))return e;let n=0;for(const t in e)if(e.hasOwnProperty(t)){if(e[t]!==r[t])break;n++}return e.slice(n)}export{l as decodePointer,f as decodePointerFragment,p as encodePointer,h as encodePointerFragment,g as extractPointerFromRef,d as extractSourceFromRef,m as getFirstPrimitiveProperty,b as getJsonPathForPosition,w as getLastPathSegment,v as getLocationForJsonPath,O as hasRef,y as isLocalRef,S as parseTree,x as parseWithPointers,I as pathToPointer,P as pointerToPath,M as renameObjectKey,U as safeParse,R as safeStringify,D as startsWith,V as toPropertyPath,C as trimStart};

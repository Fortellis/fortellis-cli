# DynamoDB service

## Installation

```bash
npm install --save @cdkglobal/fortellis-dev-utils
```

## Why use this utility over DocumentClient

This utility wraps over the AWS DynamoDB DocumentClient and provides out of the box logging and error handling that conforms to Fortellis best practices. This utility also wraps the `.promise()` support of DocumentClient making promises the default behavior.

## Prerequisites

- Node.js `^8.0.0` is required to support async/await (AWS Lambda supports `v8.10.0` and `v10.15.0`)
- Configured `.npmrc` to point your npm registry to the cdk artifactory host:

    ```text
    registry=http://artifactory.cdk.com/artifactory/api/npm/npm-repo
    ```

## API

The Fortellis DynamoDB utility mirrors the API provided by [Dynamo DocumentClient](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB/DocumentClient.html).

```javascript
DynamoDB.batchGet(params) => Promise(AWS.Request)
DynamoDB.batchWrite(params) => Promise(AWS.Request)
DynamoDB.delete(params) => Promise(AWS.Request)
DynamoDB.get(params) => Promise(AWS.Request)
DynamoDB.put(params) => Promise(AWS.Request)
DynamoDB.query(params) => Promise(AWS.Request)
DynamoDB.scan(params) => Promise(AWS.Request)
DynamoDB.update(params) => Promise(AWS.Request)


/**********************
 * DEPRECATED METHODS *
 **********************
 * - Included for backwards compatibility
 * - Do not contain updated logging & error handling
 */
DynamoDB.getItems(params)    // alias for scan
DynamoDB.queryItems(params)  // alias for query
DynamoDB.getItem(params)     // alias for get
DynamoDB.addItem(params)     // alias for put
DynamoDB.updateItem(params)  // alias for update
```

## Usage

1. You must configure AWS in your application in order to correctly set up the underlying DocumentClient.

    ```javascript
    const aws = require('aws-sdk');

    // Access credentials for dynamo access
    // This is optional if your lambda is already configured to access dynamo
    aws.config.update({
    accessKeyId: 'ACCESS_KEY',
    secretAccessKey: 'SECRET_KEY',
    region: 'REGION'
    })
    ```

2. You also need to setup the logging context of the Fortellis logging service so that your log messages will be tagged for your app specifically in Splunk.

    ```javascript
    const { logService: logger } = require("@cdkglobal/fortellis-dev-utils");
    logger.setContext('YOU_SERVICE_NAME');
    ```

    > If you are not familiar with the Fortellis logger please refer to the `logService` [README](/src/logging/README.md)

3. You can now use the DynamoDB utility in your project.

    ```javascript
    const { DynamoDB } = require("@cdkglobal/fortellis-dev-utils")

    try {
        const { Items, Count } = await DynamoDB.scan({ TableName: 'MY_DYNAMO_TABLE' });
        // Info level log created denoting success and current context
        res.status(200);
        res.json(Items);
    } catch(err) {
        // Error level log created denoting error, including params and dynamo response
        const { httpCode, message } = err;
        res.status(httpCode);
        res.send(message);
    }
    ```

    > For more information about DynamoDB params and return values please reference the [AWS DynamoDB DocumentClient docs](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB/DocumentClient.html)

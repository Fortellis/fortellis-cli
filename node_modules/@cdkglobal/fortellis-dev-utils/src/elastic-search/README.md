# Elasticsearch

## why this service

This utility wraps over the elasticsearch library and provides a searching mechanism by sorting through large collections of documents in order to find ones that are relevant to a given input query. This utility also uses the aws-sdk to make signed requests to an Amazon ES endpoint by using http-aws-es library. Resultsconverter used to convert the elasticsearch results to an actual required results.

## Installation

```bash
npm i --save @cdkglobal/fortellis-dev-utils
```

## Prerequisites

- Node.js 8.0+ for asyn/await(Don't worry AWS lambda now supports Node 8.10)
- You have configured npm registry to cdk artifactory (.npmrc file in your root should do)
http://artifactory.cdk.com/artifactory/api/npm/npm-repo
- Elastic Cluster Index should be created along with required IAM polices. References for Setup of elastic cluster index and configuring IAM polices as in below repos.
  * https://stash.cdk.com/projects/CEXCHNG/repos/terraform-modules/browse/aws-elasticsearch-domain-index-access
  * https://stash.cdk.com/projects/CEXCHNG/repos/core-platform/browse/tf/dev/policies/es-dev-access-policy.json 

## API

```javascript

ElasticSearch.search(params)    // ElasticSearch.search

/* index, query payload and error message params gets passed to search method of ElasticSearch.
   ElasticSearch api reference - https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/quick-start.html#_creating_a_client
*/

```

## Usage

```javascript

// STEP 1 - CONFIGURE ELASTICSEARCH BARE DOMAIN AND AWS REGION. - This could be done in application environment config file. For example

AWS_REGION="us-west-2";
ELASTIC_SEARCH_BARE_DOMAIN="https://search-dev-coreplat-fortellis-nnrl25vovt3xymynojalk5aqdy.us-west-2.es.amazonaws.com"

// STEP 2 - Load the ElasticSearch
const { elasticSearch: {ElasticSearch, resultsConverter} } = require("@cdkglobal/fortellis-dev-utils");

// STEP 3 - Configure ElasticSearch
const elasticSearchService = new ElasticSearch(ELASTIC_SEARCH_BARE_DOMAIN, AWS_REGION);

// STEP 3 - Call search method of ElasticSearch
async function search(req, res){
try {
       //Return the results as elasticsearch obj.
        const results = await elasticSearchService.search({
          index: 'your_index',
          payload: 'your_query',
          errorMsg: 'your_error_message'
        });
        //Converted the results to actual array of objects.
        const convertedResults = resultsConverter(results);
        return { httpCode: 200, convertedResults };
      } catch (err) {
        const { message = 'your_error_message' } = err;
        logger.error({
          message,
          details: errorMsg
        });
        return { httpCode: 500, code: 1, message };
        //Returning error message to client
        //return { httpCode: 500, message }
        //Now that we kept the message same in the client response and in the logger.error,
        //we can query the same in splunk to see the actual error trace from the upstream server.
      }
}

search();
```

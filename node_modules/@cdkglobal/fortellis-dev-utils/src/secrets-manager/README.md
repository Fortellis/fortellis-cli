# Secrets Manager

## why this service

Secrets Manager api from aws-sdk is callback based, this module brings in support for promise based usage to leverage async/awaits

## Installation

```bash
npm i --save @cdkglobal/fortellis-dev-utils
```

## Prerequisites

- Node.js 8.0+ for asyn/await(Don't worry AWS lambda now supports Node 8.10)
- You have configured npm registry to cdk artifactory (.npmrc file in your root should do)
http://artifactory.cdk.com/artifactory/api/npm/npm-repo

## API

```javascript

SecrestManager.getSecretValue(params)    // SecretsManager.getSecretValue

/* params gets passed to SecretsManager
   SecretsManager api reference - https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SecretsManager.html
*/

```

## Usage

```javascript

// STEP 1 - CONFIGURE AWS - This could go in app.js
const aws = require('aws-sdk');

// Access credentials for secrets manager access, this is optional if you lambda is already configured to access secrets manager
aws.config.update({
   accessKeyId: 'ACCESS_KEY',
   secretAccessKey: 'SECRET_KEY',
   region: 'REGION'
})

// STEP 2 - Set log context so that all log generated from secrets manager service wil be tagged with your app context for better searching in splunk. If you are not clear on what this means, please refer the Logging Best Practices guide documented in the README in this project root .
// This config could also go in app.js

const { logService: logger } = require("@cdkglobal/fortellis-dev-utils");
logger.setContext('YOU_SERVICE_NAME');

// STEP 3 - Load the Dynamo service
const { SecretsManager } = require("@cdkglobal/fortellis-dev-utils")

async function getCreds(req, res){
    try{
        const creds = await SecretsManager.getSecretValue({SecretId: secretName});
        logger.info({message: 'Fetched credentials successfully' });
    }catch(error){
        const message = 'getSecretValue operation failed';
        logger.error({ message, error });
        //Returning error message to client
        //return { httpCode: 500, message }
        //Now that we kept the message same in the client response and in the logger.error,
        //we can query the same in splunk to see the actual error trace from the upstream server.
    }
}

getCreds();
```

const jwt = require('jsonwebtoken');

function decodeAuth(auth) {
  const authCode = auth.split(' ')[1];
  return jwt.decode(authCode);
}

function localApiGateway(req, res, next) {
  const {
    roles = [],
    sub = '',
    uid = '',
    address = {},
    cid = '',
    entityId = '',
    entitlements = ''
  } = decodeAuth(req.header('Authorization'));
  req.apiGateway = {
    event: {
      requestContext: {
        authorizer: {
          roles: roles.join(' '),
          username: sub,
          uid,
          address: JSON.stringify(address),
          cid,
          entityId,
          entitlements
        }
      }
    }
  };
  next();
}

module.exports = localApiGateway;

# Fortellis Express Middleware

## Local API Gateway middleware

Development util for mocking out the API Gateway auth structure on your local machine so you can run it like its in dev!

```js
const { localApiGateway } = require('fortellis-dev-utils');
if (config.dev) {
  app.use(localApiGateway);
}
```

## Entitlements Processor Middleware

This package includes an express middleware function for determining action permissions based on user entitlements within the Fortellis ecosystem.

### API

The `entitlements-processor` takes two arguments and returns a valid express middleware function.

| Param               | Type     | Description                                                                                                                                                              | Example                                                       |
| ------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------- |
| `permission`        | `object` | Contains the resource and action required to allow the user through to the endpoint, if `undefined` the middleware will assume no permissions needed only entity context | `{ resource: 'perms-mgmt', action: 'assignStatementToUser' }` |
| `findEntityContext` | `func`   | Unary function that accepts a node req object and returns a Fortellis entityId. Used to determine the current context of the action                                      | `req => req.params.entityId`                                  |
| `findUsername`   | `func`   | Unary function that accepts a node req object and returns a Fortellis username (developerId). Used to determine the current context of the action                        | `req => req.params.developerId`                               |
| `findUid`   | `func`   | Unary function that accepts a node req object and returns a Fortellis user ID (uid). Used to determine the current context of the action                        | `req => req.params.uid`                               |

### Entitlements Processor - Usage

Default usecase, testing entitlements model for permission to take actions.

```js
const APPROVE_PERMISSION = {
  resource: 'perms-mgmt',
  action: 'assignStatementToUser'
};

app
  .route('/entities/:entityId/approve')
  .post(
    entitlementsProcessor(APPROVE_PERMISSION, req => req.params.entityId),
    entitiesAdminService.approve
  );
```

Modified usecase, checking ownership using either entityId, Username, or UID. The following example will only check for "entity" ownership:

```js
app
  .route('/entities/:entityId/approve')
  .post(
    entitlementsProcessor(undefined, req => req.params.entityId),
    entitiesAdminService.approve
  );
```

This example will check for either entity ownership OR user ownership by UID. This usecase is helpful when a resource can be either entity/personal owned based on a difference in fields.

> For example: if the given spec being updated was owned by the user the `entityId` field would be `undefined` so the entity check would fail but the `uid` check passes because the user is correctly accessing their own spec so the request is allowed through.

```js
app
  .route('/spec/:id')
  .put(
    entitlementsProcessor(undefined, req => req.body.entityId, undefined, req => req.body.uid),
    specService.update
  );
```

Ownership can be checked in any combination of the three avaliable identifiers (entityId, username, or UID) by simply only specifying the get functions for the identifiers you wish to check.

## Traffic Logger Middleware

Express middleware function to allow Fortellis services to trivially log requests and responses in a consistent manner.

### Traffic Logger - Usage

```js
const {
  logService: logger,
  middleware: { trafficLogger }
} = require('@cdkglobal/fortellis-dev-utils');
logger.setContext('SOME_FORTELLIS_SERVICE');

app.use(trafficLogger(logger.info));
```
